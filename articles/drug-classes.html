<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting drug classes from the OMOP hierarchy • omopcept</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting drug classes from the OMOP hierarchy">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">omopcept</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.6.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/drug-classes.html">Getting drug classes from the OMOP hierarchy</a></li>
    <li><a class="dropdown-item" href="../articles/getting-omop-concept-data.html">getting-omop-concept-data</a></li>
    <li><a class="dropdown-item" href="../articles/hierarchy-for-blood-counts.html">Exploring OMOP hierarchy for blood counts</a></li>
    <li><a class="dropdown-item" href="../articles/query-and-graph-concept-hierarchies.html">query-and-graph-concept-hierarchies</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SAFEHR-data/omopcept/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting drug classes from the OMOP hierarchy</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/SAFEHR-data/omopcept/blob/master/vignettes/drug-classes.Rmd" class="external-link"><code>vignettes/drug-classes.Rmd</code></a></small>
      <div class="d-none name"><code>drug-classes.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://SAFEHR-data.github.io/omopcept/" class="external-link">omopcept</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/CodelistGenerator/" class="external-link">CodelistGenerator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
<p><strong>DRAFT</strong></p>
<div class="section level2">
<h2 id="tldr">TLDR<a class="anchor" aria-label="anchor" href="#tldr"></a>
</h2>
<p>omopcept has recently gained a function
<code><a href="../reference/omop_drug_lookup_create.html">omop_drug_lookup_create()</a></code> to create a lookup table from
drug concept IDs to drug classes in the ATC classification. To create a
lookup table for all RxNorm Extension Ingredients :</p>
<pre><code><span><span class="va">drug_lookup</span> <span class="op">=</span> <span class="fu"><a href="../reference/omop_drug_lookup_create.html">omop_drug_lookup_create</a></span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="use-case">Use case<a class="anchor" aria-label="anchor" href="#use-case"></a>
</h2>
<p>Researchers want to be able to identify drug classes from an omop
extract that has more specific drug names.</p>
<p>Maybe 1. antibiotics 1. broad spectrum antibiotics 1. specific
antibiotic classes</p>
</div>
<div class="section level2">
<h2 id="atc-a-who-drug-classification">ATC a WHO drug classification<a class="anchor" aria-label="anchor" href="#atc-a-who-drug-classification"></a>
</h2>
<p><a href="https://atcddd.fhi.no/atc/structure_and_principles/" class="external-link">ATC</a>
the Anatomical Therapeutic Chemical Classification System maintained by
WHO and the Defined Daily Dose (DDD) as a measuring unit “have become
the gold standard for international drug utilization monitoring and
research”.</p>
<p>In ATC, active substances are classified in a hierarchy with five
levels. The system has fourteen main anatomical/pharmacological groups
or 1st levels. Each ATC main group is divided into 2nd levels which
could be either pharmacological or therapeutic groups. The 3rd and 4th
levels are chemical, pharmacological or therapeutic subgroups and the
5th level is the chemical substance.</p>
</div>
<div class="section level2">
<h2 id="atc-in-omop-via-rxnorm-extension-rxnorm">ATC in OMOP via RxNorm Extension &amp; RxNorm<a class="anchor" aria-label="anchor" href="#atc-in-omop-via-rxnorm-extension-rxnorm"></a>
</h2>
<p>In OMOP each drug concept ID in the vocabularies
<code>RxNorm Extension</code> &amp; <code>RxNorm</code> has ancestor
concepts in the different levels of the ATC hierarchy. The new omopcept
function <code><a href="../reference/omop_drug_lookup_create.html">omop_drug_lookup_create()</a></code> creates a lookup table
from drug concept IDs to drug classes in the ATC classification.</p>
</div>
<div class="section level2">
<h2 id="does-anything-else-already-do-this">Does anything else already do this ?<a class="anchor" aria-label="anchor" href="#does-anything-else-already-do-this"></a>
</h2>
<p>I couldn’t quite get anything to provide a comprehensive list of drug
classes.</p>
<p>Seems that the <a href="https://github.com/darwin-eu/CodelistGenerator" class="external-link">CodelistGenerator
package</a> does things that could solve this.</p>
<p><a href="https://github.com/darwin-eu/CodelistGenerator/blob/main/R/drugCodes.R" class="external-link">CodelistGenerator::getATCCodes</a>
returns descendants of ATC classes.</p>
<p><span class="citation">@param</span> level ATC level. Can be one or
more of “ATC 1st”, “ATC 2nd”, “ATC 3rd”, “ATC 4th”, and “ATC 5th” <span class="citation">@param</span> name ATC name of interest. For example,
c(“Dermatologicals”, “Nervous System”), would result in a list of length
two with the descendant concepts for these two particular ATC
groups.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/CodelistGenerator/reference/mockVocabRef.html" class="external-link">mockVocabRef</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in validateCdmReference(cdm, soft = .softValidation): There are observation period end dates after the current date: 2025-06-30</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The latest max observation period end date found is 2025-12-31</span></span>
<span><span class="va">atc1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/CodelistGenerator/reference/getATCCodes.html" class="external-link">getATCCodes</a></span><span class="op">(</span>cdm <span class="op">=</span> <span class="va">cdm</span>, level <span class="op">=</span> <span class="st">"ATC 1st"</span><span class="op">)</span></span>
<span><span class="co"># atc2 &lt;- getATCCodes(cdm = cdm, level = "ATC 2nd")</span></span>
<span><span class="co"># Error in getATCCodes(cdm = cdm, level = "ATC 2nd") : 2 assertions failed:</span></span>
<span><span class="co">#  * - No matching ATC codes found</span></span>
<span><span class="co">#  * Variable 'atcCheck': Must be TRUE.</span></span></code></pre></div>
<p>But these only show results that are in a CDM. I’d like comprehensive
results to help me make sure its doing what I want before I apply it to
any data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># OLD exploration</span></span>
<span><span class="co"># eval=FALSE because much of this replaced by omop_drug_lookup_create()</span></span>
<span></span>
<span><span class="co">#300k rows</span></span>
<span><span class="va">rxn</span> <span class="op">&lt;-</span> <span class="fu">omopcept</span><span class="fu">::</span><span class="fu"><a href="../reference/omop_names.html">omop_names</a></span><span class="op">(</span><span class="st">""</span>, v<span class="op">=</span><span class="st">"RxNorm"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/omopfreqconceptclass.html">omopfreqconceptclass</a></span><span class="op">(</span><span class="va">rxn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># doesn't seem to have ATC classes I want ??</span></span>
<span></span>
<span><span class="co">#    concept_class_id         n</span></span>
<span><span class="co">#    &lt;chr&gt;                &lt;int&gt;</span></span>
<span><span class="co">#  1 Clinical Drug        53083</span></span>
<span><span class="co">#  2 Branded Drug         39083</span></span>
<span><span class="co">#  3 Clinical Drug Comp   38474</span></span>
<span><span class="co">#  4 Branded Drug Comp    36748</span></span>
<span><span class="co">#  5 Branded Drug Form    26595</span></span>
<span><span class="co">#  6 Branded Dose Group   23388</span></span>
<span><span class="co">#  7 Clinical Drug Form   20773</span></span>
<span><span class="co">#  8 Brand Name           19469</span></span>
<span><span class="co">#  9 Clinical Dose Group  17741</span></span>
<span><span class="co"># 10 Ingredient           15604</span></span>
<span><span class="co"># 11 Multiple Ingredients  4469</span></span>
<span><span class="co"># 12 Quant Clinical Drug   3860</span></span>
<span><span class="co"># 13 Precise Ingredient    3476</span></span>
<span><span class="co"># 14 Quant Branded Drug    3215</span></span>
<span><span class="co"># 15 Branded Pack          1308</span></span>
<span><span class="co"># 16 Clinical Pack         1175</span></span>
<span><span class="co"># 17 Dose Form              201</span></span>
<span><span class="co"># 18 Dose Form Group         47</span></span>
<span></span>
<span><span class="co"># Aha, by looking at code for CodeListGenerator I see that the ATC classes are not in RxNorm but in a vocab called ATC</span></span>
<span></span>
<span><span class="co">#6740 rows</span></span>
<span><span class="va">atc</span> <span class="op">&lt;-</span> <span class="fu">omopcept</span><span class="fu">::</span><span class="fu"><a href="../reference/omop_names.html">omop_names</a></span><span class="op">(</span><span class="st">""</span>, v<span class="op">=</span><span class="st">"ATC"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/omopfreqconceptclass.html">omopfreqconceptclass</a></span><span class="op">(</span><span class="va">atc</span><span class="op">)</span></span>
<span><span class="co"># 1 ATC 5th           5452</span></span>
<span><span class="co"># 2 ATC 4th            911</span></span>
<span><span class="co"># 3 ATC 3rd            269</span></span>
<span><span class="co"># 4 ATC 2nd             94</span></span>
<span><span class="co"># 5 ATC 1st             14</span></span>
<span></span>
<span><span class="co"># TO be able to get ATC classes for any drug concept</span></span>
<span><span class="co"># take the ancestor table</span></span>
<span><span class="co"># filter all ancestor_concept_id that are in vocab ATC</span></span>
<span><span class="co"># can then use filter any descendant_concept_id that appears in user data</span></span>
<span><span class="co"># and should end up with vector of ATC classes at the different levels</span></span>
<span></span>
<span><span class="co">#9 million ATC descendants !!</span></span>
<span></span>
<span><span class="va">atc_descendants</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/omop_concept_ancestor.html">omop_concept_ancestor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">#ideally would do before collect</span></span>
<span>  <span class="co">#but get Error in df[[id_col_name]] &lt;- as.integer(df[[id_col_name]]) : cannot add bindings to a locked environment</span></span>
<span>  <span class="co">#that I can probably fix in omopcept</span></span>
<span>  <span class="co">#collect() |&gt; </span></span>
<span>  <span class="fu"><a href="../reference/omop_join_name.html">omop_join_name</a></span><span class="op">(</span>namestart <span class="op">=</span> <span class="st">"ancestor"</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"concept_name"</span>,<span class="st">"vocabulary_id"</span>,<span class="st">"concept_class_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">#renaming of joined columns to differentiate ancestor &amp; descendant</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>ancestor_vocabulary_id <span class="op">=</span> <span class="va">vocabulary_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>ancestor_concept_class_id <span class="op">=</span> <span class="va">concept_class_id</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="../reference/omop_join_name.html">omop_join_name</a></span><span class="op">(</span>namestart <span class="op">=</span> <span class="st">"descendant"</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"concept_name"</span>,<span class="st">"vocabulary_id"</span>,<span class="st">"concept_class_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>descendant_vocabulary_id <span class="op">=</span> <span class="va">vocabulary_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>descendant_concept_class_id <span class="op">=</span> <span class="va">concept_class_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="co">#head(100) |&gt; </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_vocabulary_id</span><span class="op">==</span><span class="st">"ATC"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">atc_descendants</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">descendant_vocabulary_id</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># 1 RxNorm Extension         8732808</span></span>
<span><span class="co"># 2 RxNorm                    819887</span></span>
<span><span class="co"># 3 ATC                        30849</span></span>
<span><span class="co"># 4 HCPCS                        140</span></span>
<span><span class="co"># 5 HemOnc                        66</span></span>
<span></span>
<span><span class="va">atc_descendants</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">ancestor_concept_class_id</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#8.7m rows</span></span>
<span><span class="va">atc_rxnormext_descendants</span> <span class="op">&lt;-</span> <span class="va">atc_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">descendant_vocabulary_id</span> <span class="op">==</span> <span class="st">"RxNorm Extension"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>ATC_concept_id <span class="op">=</span> <span class="va">ancestor_concept_id</span>,</span>
<span>         ATC_concept_name <span class="op">=</span> <span class="va">ancestor_concept_name</span>,</span>
<span>         drug_concept_id <span class="op">=</span> <span class="va">descendant_concept_id</span>,</span>
<span>         drug_concept_name <span class="op">=</span> <span class="va">descendant_concept_name</span>,</span>
<span>         ATC_level <span class="op">=</span> <span class="va">ancestor_concept_class_id</span>,</span>
<span>         <span class="co">#this is RxNormExtension concept class e.g. Branded Drug etc.</span></span>
<span>         <span class="co">#probably don't need because it will be in drug_exposure table</span></span>
<span>         <span class="co">#but may be useful here during development</span></span>
<span>         concept_class_id <span class="op">=</span> <span class="va">descendant_concept_class_id</span></span>
<span>         <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="co">#extract numeric part of the ATC level</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ATC_level <span class="op">=</span> <span class="fu">str_sub</span><span class="op">(</span><span class="va">ATC_level</span>,<span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atc_rxnormext_descendants</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">concept_class_id</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#  1 Marketed Product    2692126</span></span>
<span><span class="co">#  2 Branded Drug Box    1084960</span></span>
<span><span class="co">#  3 Branded Drug         856819</span></span>
<span><span class="co">#  4 Branded Drug Comp    710365</span></span>
<span><span class="co">#  5 Branded Drug Form    569727</span></span>
<span><span class="co">#  6 Clinical Drug Box    532821</span></span>
<span><span class="co">#  7 Quant Branded Drug   467679</span></span>
<span><span class="co">#  8 Quant Branded Box    411968</span></span>
<span><span class="co">#  9 Quant Clinical Drug  346667</span></span>
<span><span class="co"># 10 Clinical Drug        333783</span></span>
<span><span class="co"># 11 Quant Clinical Box   324265</span></span>
<span><span class="co"># 12 Clinical Drug Comp   200522</span></span>
<span><span class="co"># 13 Clinical Drug Form   151217</span></span>
<span><span class="co"># 14 Branded Pack          16291</span></span>
<span><span class="co"># 15 Clinical Pack         12935</span></span>
<span><span class="co"># 16 Ingredient             8911</span></span>
<span><span class="co"># 17 Branded Pack Box       6604</span></span>
<span><span class="co"># 18 Clinical Pack Box      5148</span></span>
<span></span>
<span><span class="co">#SOMETHING NOT RIGHT ? SEEMS CAN'T FIND MANY DRUGS IN HERE</span></span>
<span></span>
<span><span class="co">#TODO check in one of UCLH extracts what the values of RxNormExt concept_class_id are</span></span>
<span><span class="co">#e.g. is it just Ingredient ?</span></span>
<span></span>
<span><span class="va">atc_rxnormext_ingredient</span> <span class="op">&lt;-</span> <span class="va">atc_rxnormext_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">concept_class_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ingredient"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atc2ingredients</span> <span class="op">&lt;-</span> <span class="va">atc_rxnormext_ingredient</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ATC_level</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ATC 1st"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atc_rxnormext_clinicaldrug</span> <span class="op">&lt;-</span> <span class="va">atc_rxnormext_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">concept_class_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Clinical Drug"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atc_tmp</span> <span class="op">&lt;-</span> <span class="va">atc_rxnormext_descendants</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atc_from_rxnormext_ingredient</span> <span class="op">&lt;-</span> <span class="va">atc_rxnormext_ingredient</span> <span class="op">|&gt;</span> </span>
<span><span class="co">#atc_from_rxnormext_wide &lt;- atc_rxnormext_descendants |&gt; </span></span>
<span><span class="co">#atc_from_rxnormext_wide &lt;- atc_tmp |&gt; </span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">ATC_level</span>, </span>
<span>              values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ATC_concept_name</span>, <span class="va">ATC_concept_id</span><span class="op">)</span>, </span>
<span>              id_cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">drug_concept_name</span>, <span class="va">drug_concept_id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Warning message:</span></span>
<span><span class="co"># Values from `ATC_concept_id` and `ATC_concept_name` are not uniquely identified; output will contain list-cols.</span></span>
<span><span class="co"># Use the following dplyr code to identify duplicates.</span></span>
<span><span class="co"># 800k rows !</span></span>
<span><span class="co">#dup &lt;- atc_rxnormext_descendants |&gt;</span></span>
<span><span class="va">dup</span> <span class="op">&lt;-</span> <span class="va">atc_rxnormext_ingredient</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">drug_concept_name</span>, <span class="va">drug_concept_id</span>, <span class="va">ATC_level</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SO a drug can be in more than one ATC class</span></span>
<span></span>
<span><span class="co"># lets have a look at a single drug example</span></span>
<span></span>
<span><span class="va">drugname</span> <span class="op">&lt;-</span> <span class="st">"biapenem"</span></span>
<span><span class="va">drugname</span> <span class="op">&lt;-</span> <span class="st">"Bromisoval"</span> <span class="co">#apparently has 37 duplicates !!</span></span>
<span><span class="va">drugname</span> <span class="op">&lt;-</span> <span class="st">"Azidamfenicol"</span> <span class="co">#10 duplicates</span></span>
<span></span>
<span><span class="va">oneingredient</span> <span class="op">&lt;-</span> <span class="va">atc_rxnormext_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">drug_concept_name</span> <span class="op">==</span> <span class="va">drugname</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">ATC_level</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#biapenem has single entry per ATC level</span></span>
<span><span class="co">#   ATC_concept_id ATC_concept_name                 drug_concept_id drug_concept_name ATC_level concept_class_id</span></span>
<span><span class="co"># 1       21602795 ANTIINFECTIVES FOR SYSTEMIC USE         35198093 biapenem          ATC 1st   Ingredient      </span></span>
<span><span class="co"># 2       21602796 ANTIBACTERIALS FOR SYSTEMIC USE         35198093 biapenem          ATC 2nd   Ingredient      </span></span>
<span><span class="co"># 3       21602868 OTHER BETA-LACTAM ANTIBACTERIALS        35198093 biapenem          ATC 3rd   Ingredient      </span></span>
<span><span class="co"># 4       21602920 Carbapenems                             35198093 biapenem          ATC 4th   Ingredient      </span></span>
<span><span class="co"># 5       21602924 biapenem; parenteral                    35198093 biapenem          ATC 5th   Ingredient  </span></span>
<span></span>
<span><span class="co">#but e.g. Azidamfenicol has multiple entries in all ATC levels</span></span>
<span><span class="co">#suggests that maybe we need multiple rows per drug (i.e. keep data long)</span></span>
<span><span class="co">#perhaps function can offer option for short &amp; long ?</span></span>
<span><span class="co">#OR maybe start by producing a long lookup table because we are close to that already</span></span>
<span><span class="co">#</span></span>
<span></span>
<span><span class="co">#even Bromisoval, most duplicates are in level 5</span></span>
<span><span class="co">#oneingredient |&gt; count(ATC_level, sort=TRUE)</span></span>
<span><span class="co"># 1 ATC 5th      37</span></span>
<span><span class="co"># 2 ATC 4th       6</span></span>
<span><span class="co"># 3 ATC 3rd       4</span></span>
<span><span class="co"># 4 ATC 1st       1</span></span>
<span><span class="co"># 5 ATC 2nd       1</span></span>
<span></span>
<span><span class="co">#TEMPTED to try to plot relationships of ATC levels</span></span>
<span><span class="co">#probably 1-3</span></span>
<span></span>
<span></span>
<span><span class="co">#I think we may want ATC (3rd level, pharmacological subgroup)</span></span>
<span><span class="va">atc3_rxnormext_descendants</span> <span class="op">&lt;-</span> <span class="va">atc_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">descendant_vocabulary_id</span> <span class="op">==</span> <span class="st">"RxNorm Extension"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_class_id</span> <span class="op">==</span> <span class="st">"ATC 3rd"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atc2_rxnormext_descendants</span> <span class="op">&lt;-</span> <span class="va">atc_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">descendant_vocabulary_id</span> <span class="op">==</span> <span class="st">"RxNorm Extension"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_class_id</span> <span class="op">==</span> <span class="st">"ATC 2nd"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atc1_rxnormext_descendants</span> <span class="op">&lt;-</span> <span class="va">atc_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">descendant_vocabulary_id</span> <span class="op">==</span> <span class="st">"RxNorm Extension"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_class_id</span> <span class="op">==</span> <span class="st">"ATC 1st"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#234 rows at ATC3</span></span>
<span><span class="va">freq_atc3</span> <span class="op">&lt;-</span> <span class="va">atc3_rxnormext_descendants</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">ancestor_concept_name</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#90 rows at ATC2</span></span>
<span><span class="va">freq_atc2</span> <span class="op">&lt;-</span> <span class="va">atc2_rxnormext_descendants</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">ancestor_concept_name</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#14 rows at ATC1</span></span>
<span><span class="va">freq_atc1</span> <span class="op">&lt;-</span> <span class="va">atc1_rxnormext_descendants</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">ancestor_concept_name</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cyto</span> <span class="op">&lt;-</span> <span class="va">atc3_rxnormext_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_name</span> <span class="op">==</span> <span class="st">"CYTOTOXIC ANTIBIOTICS AND RELATED SUBSTANCES"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#amoxicillin etc.</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">atc3_rxnormext_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_name</span> <span class="op">==</span> <span class="st">"BETA-LACTAM ANTIBACTERIALS, PENICILLINS"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#OTHER BETA-LACTAM ANTIBACTERIALS</span></span>
<span></span>
<span></span>
<span><span class="co">#find what level2 is for level3= "BETA-LACTAM ANTIBACTERIALS, PENICILLINS"</span></span>
<span><span class="va">beta_atc2</span> <span class="op">&lt;-</span> <span class="va">atc_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_class_id</span> <span class="op">==</span> <span class="st">"ATC 2nd"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">descendant_concept_name</span> <span class="op">==</span> <span class="st">"BETA-LACTAM ANTIBACTERIALS, PENICILLINS"</span><span class="op">)</span>  </span>
<span></span>
<span><span class="va">anti_atc3</span> <span class="op">&lt;-</span> <span class="va">atc_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_name</span> <span class="op">==</span> <span class="st">"ANTIBACTERIALS FOR SYSTEMIC USE"</span> <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">descendant_concept_class_id</span> <span class="op">==</span> <span class="st">"ATC 3rd"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anti_atc4</span> <span class="op">&lt;-</span> <span class="va">atc_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_name</span> <span class="op">==</span> <span class="st">"ANTIBACTERIALS FOR SYSTEMIC USE"</span> <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">descendant_concept_class_id</span> <span class="op">==</span> <span class="st">"ATC 4th"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta_atc1</span> <span class="op">&lt;-</span> <span class="va">atc_descendants</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ancestor_concept_class_id</span> <span class="op">==</span> <span class="st">"ATC 1st"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">descendant_concept_name</span> <span class="op">==</span> <span class="st">"BETA-LACTAM ANTIBACTERIALS, PENICILLINS"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">a3_and_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">anti_atc3</span>, <span class="va">anti_atc4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#SO WHAT WE COULD DO is create a post-processing script that will add columns to the omop extracts for ATC2,3,&amp; 4 likely to be most useful</span></span>
<span><span class="co">#TODO</span></span>
<span><span class="co">#write a function addATC_to_drug_concepts()</span></span>
<span><span class="co">#want to add 1 column for each ATC level</span></span>
<span><span class="co">#probably by filtering all ATC levels &amp; then doing pivot_wider()</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andy South.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
